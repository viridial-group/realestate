input {
  # TCP input pour recevoir les logs des services Spring Boot
  tcp {
    port => 5000
    codec => json_lines
    type => "spring-boot-logs"
  }
  
  # UDP input (optionnel, pour les logs non-JSON)
  # udp {
  #   port => 5001
  #   codec => json_lines
  #   type => "spring-boot-logs"
  # }
}

filter {
  # Parser les logs JSON
  if [type] == "spring-boot-logs" {
    # Extraire les champs du log JSON
    if [message] {
      json {
        source => "message"
        target => "log"
      }
    }
    
    # Extraire le timestamp
    if [log][timestamp] {
      date {
        match => [ "log[timestamp]", "yyyy-MM-dd HH:mm:ss.SSS" ]
        target => "@timestamp"
      }
    }
    
    # Extraire le niveau de log
    if [log][level] {
      mutate {
        add_field => { "log_level" => "%{[log][level]}" }
      }
    }
    
    # Extraire le service name
    if [log][logger] {
      if [log][logger] =~ /^com\.realestate\.(.*?)\..*$/ {
        mutate {
          add_field => { "service_name" => "%{[log][logger]}" }
        }
      }
    }
    
    # Extraire le thread
    if [log][thread] {
      mutate {
        add_field => { "thread_name" => "%{[log][thread]}" }
      }
    }
    
    # Extraire le message
    if [log][message] {
      mutate {
        add_field => { "log_message" => "%{[log][message]}" }
      }
    }
    
    # Extraire les exceptions
    if [log][exception] {
      mutate {
        add_field => { "exception" => "%{[log][exception]}" }
      }
    }
    
    # Extraire les trace
    if [log][trace] {
      mutate {
        add_field => { "stack_trace" => "%{[log][trace]}" }
      }
    }
    
    # Nettoyer les champs
    mutate {
      remove_field => [ "log" ]
    }
  }
  
  # Ajouter des tags pour faciliter la recherche
  if [log_level] == "ERROR" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  if [log_level] == "WARN" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
}

output {
  # Envoyer vers Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "realestate-logs-%{+YYYY.MM.dd}"
    # Template sera créé automatiquement si nécessaire
    # template_name => "realestate-logs"
    # template => "/usr/share/logstash/templates/realestate-logs-template.json"
    # template_overwrite => true
  }
  
  # Debug (optionnel, à désactiver en production)
  # stdout {
  #   codec => rubydebug
  # }
}

